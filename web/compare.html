<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Compare runs</title>
  <link rel="stylesheet" href="../config/theme.css"/>
  <style>
    body{background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .btn{display:inline-block;padding:8px 12px;border:1px solid var(--muted);border-radius:10px;background:#141617;color:var(--ink);text-decoration:none}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:12px 0}
    select{background:#121416;color:var(--ink);border:1px solid var(--muted);border-radius:8px;padding:8px;min-width:260px}
    table{width:100%;border-collapse:collapse;margin-top:16px;background:#111315;border:1px solid var(--muted);border-radius:12px;overflow:hidden}
    th,td{padding:12px;border-bottom:1px solid var(--muted);vertical-align:top}
    thead th{background:#141617}
    .small{color:var(--ink-dim);font-size:12px}
    .delta-pos{color:#8df0b6} .delta-neg{color:#ffb3b3} .delta-zero{color:#cbd0d6}
    .pill{border:1px solid var(--muted);padding:4px 10px;border-radius:999px;background:#131416;margin:4px 6px 0 0;display:inline-block}
    .chips{display:flex;flex-wrap:wrap;margin-top:6px}
    h2{margin:10px 0 6px}
  </style>
</head>
<body>
  <div class="wrap">
    <a class="btn" href="../index.html">← Leaderboard</a>
    <h2>Compare runs</h2>
    <p class="small">Pick two runs. The table shows per-metric scores and Δ (right − left). Use the button to open both reports.</p>

    <div class="row">
      <label class="small" for="leftSel">Left</label>
      <select id="leftSel" aria-label="Left run"></select>
      <label class="small" for="rightSel">Right</label>
      <select id="rightSel" aria-label="Right run"></select>
      <a id="openBtn" class="btn" href="javascript:void(0)">Open reports</a>
    </div>

    <div id="meta" class="chips small"></div>

    <table id="cmpTable" style="display:none">
      <thead><tr id="headRow"></tr></thead>
      <tbody id="bodyRows"></tbody>
    </table>
  </div>

<script>
(async function(){
  const pct = x => (x*100).toFixed(1) + '%';
  const site = await fetch('../config/site.json').then(r=>r.json());
  const board = await fetch('../leaderboard.json').then(r=>r.json());
  const runs = (board.runs||[]);

  function opt(r){ const m=r.model||'—'; return `<option value="${r.run_id}">${r.run_id} — ${m}</option>`; }
  leftSel.innerHTML  = runs.map(opt).join('');
  rightSel.innerHTML = runs.map(opt).join('');
  if (runs.length>1){ rightSel.selectedIndex = 1; }

  const cols = site.show_columns.filter(k => !['run_id','model','provenance'].includes(k));

  headRow.innerHTML =
    `<th>Metric</th>
     <th id="lHdr" style="text-align:center"></th>
     <th id="rHdr" style="text-align:center"></th>
     <th>Δ (right−left)</th>`;

  function getRun(id){ return runs.find(r=>r.run_id===id); }

  function chips(meta, prefix, prov){
    const m = meta||{}; const keys=['model','dataset','prompt_cfg','retriever','date','prov','sig'];
    const pills = keys.filter(k=> (k=='model') or (m[k])).map(k=>{
      const v = (k=='model') ? (prefix+': '+(m||{}).model || '—') : `${k}: ${m[k]}`;
      return `<span class="pill">${v}</span>`;
    }).join('');
    const provP = prov ? `<span class="pill">prov: ${prov.status}</span>` : '';
    return pills + provP;
  }

  function render(){
    const L = getRun(leftSel.value);
    const R = getRun(rightSel.value);
    if (!L || !R){ cmpTable.style.display='none'; return; }
    cmpTable.style.display='table';

    lHdr.textContent = L.run_id;
    rHdr.textContent = R.run_id;

    meta.innerHTML =
      chips(L.meta||{}, 'Left', L.provenance) + chips(R.meta||{}, 'Right', R.provenance);

    bodyRows.innerHTML = cols.map(key=>{
      const label = (site.labels && site.labels[key]) || key;
      const lv = Number(L[key] ?? 0), rv = Number(R[key] ?? 0);
      const d  = rv - lv;
      const cls = d>0 ? 'delta-pos' : d<0 ? 'delta-neg' : 'delta-zero';
      return `<tr>
        <td>${label}</td>
        <td>${pct(lv)}</td>
        <td>${pct(rv)}</td>
        <td class="${cls}">${(d*100).toFixed(1)}%</td>
      </tr>`;
    }).join('');

    openBtn.onclick = () => {
      if (L.report) window.open('../'+L.report, '_blank');
      if (R.report) window.open('../'+R.report, '_blank');
    };
  }

  leftSel.addEventListener('change', render);
  rightSel.addEventListener('change', render);

  const q = new URLSearchParams(location.search);
  if (q.has('left'))  leftSel.value  = q.get('left');
  if (q.has('right')) rightSel.value = q.get('right');

  render();
})();
</script>
</body>
</html>
