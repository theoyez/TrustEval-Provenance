<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TrustEval — Provenance</title>
  <link rel="stylesheet" href="web/styles.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">TrustEval <span class="tier">Pro</span></div>
    <nav class="nav">
      <a href="compare.html" class="btn ghost">Compare</a>
      <a href="README.html" class="btn ghost">README</a>
    </nav>
  </header>

  <main class="container">
    <!-- Model title + description (auto-filled; falls back to generic text) -->
    <section id="modelSummary" class="card hero">
      <h1 id="modelTitle">TrustEval — Provenance</h1>
      <p id="modelBlurb">
        Cryptographic provenance folded into Trust. Click the <b>Model</b>, <b>Provenance</b>, or <b>Audit</b> pills to expand details.
        Hover any column header for definitions. Use <b>Compare</b> to see per-metric deltas.
      </p>
    </section>

    <div class="searchbar">
      <input id="searchBox" type="text" placeholder="Filter by run id, model, or notes…">
    </div>

    <section class="table-wrap">
      <table id="board" class="board">
        <thead>
          <tr>
            <th data-key="run_id">Run <span class="sort"></span></th>
            <th data-kind="model" class="pill-head">Model <span class="sort"></span></th>
            <th data-key="accuracy" data-tip="Partial-credit vs expected (exact/token/regex/edit).">Accuracy <span class="q">?</span><span class="sort"></span></th>
            <th data-key="grounding" data-tip="Citations must be allowed per item; score capped if not in retrieved top-k.">Grounding <span class="q">?</span><span class="sort"></span></th>
            <th data-key="safety" data-tip="PII/Toxicity/Policy regex packs apply bounded deductions.">Safety <span class="q">?</span><span class="sort"></span></th>
            <th data-key="robustness" data-tip="Answer stability under minor perturbations / sampling.">Robustness <span class="q">?</span><span class="sort"></span></th>
            <th data-key="bias" data-tip="Score reduction for biased outputs (rules with sampling).">Bias <span class="q">?</span><span class="sort"></span></th>
            <th data-key="calibration" data-tip="Reliability of confidence (ECE proxy).">Calibration <span class="q">?</span><span class="sort"></span></th>
            <th data-key="trust" data-tip="0.6×Acc + 0.3×Grounding + 0.1×Safety (plus provenance in this tier).">Trust <span class="q">?</span><span class="sort"></span></th>
            <th data-kind="prov" class="pill-head">Provenance</th>
            <th data-kind="audit" class="pill-head">Audit</th>
            <th>Report</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </section>
  </main>

  <!-- Simple tooltip -->
  <div id="tip" class="tooltip" role="tooltip" hidden></div>

  <script src="web/common.js"></script>
  <script>
  (async function init(){
    // Load optional model blurbs, then leaderboard
    const modelMap = await loadJSON('config/models.json').catch(()=> ({}));
    const data = await loadJSON('data/leaderboard.json');

    // Title + blurb: if a single model dominates, show it; else generic
    hydrateHeader(modelMap);

    const table = document.getElementById('board');
    const rowsEl = document.getElementById('rows');
    const filter = document.getElementById('searchBox');

    let runs = (data.runs || []).map(normalizeRun);
    let sortKey = null, sortDir = 1; // 1 asc, -1 desc
    let expanded = { id: null, kind: null }; // single open drawer per row

    function render(){
      const q = filter.value.trim().toLowerCase();
      const filtered = q ? runs.filter(r =>
        (r.run_id||'').toLowerCase().includes(q) ||
        (r.model||'').toLowerCase().includes(q) ||
        (r.notes||'').toLowerCase().includes(q)
      ) : runs.slice();

      if (sortKey){
        filtered.sort((a,b)=>{
          const va = a[sortKey], vb = b[sortKey];
          const na = typeof va === 'number' ? va : (typeof va === 'string' ? va.toLowerCase() : '');
          const nb = typeof vb === 'number' ? vb : (typeof vb === 'string' ? vb.toLowerCase() : '');
          if (na < nb) return -1*sortDir;
          if (na > nb) return 1*sortDir;
          return 0;
        });
      }

      rowsEl.innerHTML = '';
      filtered.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = 'row';
        tr.innerHTML = rowHTML(r, expanded);
        rowsEl.appendChild(tr);
        if (expanded.id === r.run_id){
          const dr = document.createElement('tr');
          dr.className = 'drawer';
          dr.innerHTML = drawerHTML(r, expanded.kind);
          rowsEl.appendChild(dr);
        }
      });

      // bind row interactions
      rowsEl.querySelectorAll('.pill').forEach(el=>{
        el.addEventListener('click', e=>{
          const id = e.currentTarget.dataset.id;
          const kind = e.currentTarget.dataset.kind; // 'model' | 'prov' | 'audit'
          if (expanded.id === id && expanded.kind === kind){
            expanded = {id:null, kind:null};
          } else {
            expanded = {id, kind};
          }
          render();
        });
      });
    }

    // sortable headers + tooltips
    table.querySelectorAll('thead th[data-key]').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.dataset.key;
        if (sortKey === key) sortDir *= -1; else { sortKey = key; sortDir = key==='run_id' ? -1 : -1; }
        table.querySelectorAll('.sort').forEach(s=> s.textContent='');
        const s = th.querySelector('.sort'); if (s) s.textContent = sortDir===1 ? '▲' : '▼';
        render();
      });
      const tipText = th.dataset.tip;
      if (tipText){
        th.addEventListener('mouseenter', (e)=> showTip(tipText, e));
        th.addEventListener('mousemove', (e)=> moveTip(e));
        th.addEventListener('mouseleave', hideTip);
      }
    });

    document.getElementById('searchBox').addEventListener('input', render);
    render();

    // Helpers
    function rowHTML(r, ex){
      return `
        <td class="mono">${escapeHTML(r.run_id)}</td>
        <td>
          <button class="pill neutral" data-id="${r.run_id}" data-kind="model">
            ▸ <span class="pill-label">${escapeHTML(r.model || '—')}</span>
          </button>
        </td>
        ${metricCell(r.accuracy)}
        ${metricCell(r.grounding)}
        ${metricCell(r.safety)}
        ${metricCell(r.robustness)}
        ${metricCell(r.bias)}
        ${metricCell(r.calibration)}
        ${metricCell(r.trust, true)}
        <td>
          ${statusPill('prov', r.provenance_status, r.run_id)}
        </td>
        <td>
          ${statusPill('audit', r.audit_status, r.run_id)}
        </td>
        <td>${r.report ? `<a class="link" href="${r.report}">Report</a>` : '—'}</td>
      `;
    }

    function metricCell(v, strong=false){
      const pct = isFinite(v) ? (v*100).toFixed(1)+'%' : '—';
      return `<td${strong?' class="strong"':''}>${pct}</td>`;
    }

    function statusPill(kind, status, id){
      const cls = status==='ok' ? 'ok' : (status==='warn' ? 'warn' : (status==='error' ? 'error' : 'neutral'));
      const label = status || '—';
      return `<button class="pill ${cls}" data-id="${id}" data-kind="${kind}">${label} ▸</button>`;
    }

    function drawerHTML(r, kind){
      let inner = '';
      if (kind === 'model'){
        inner = modelPanel(r);
      } else if (kind === 'prov'){
        inner = provenancePanel(r);
      } else { /* audit */
        inner = auditPanel(r);
      }
      return `<td colspan="12"><div class="drawer-inner">${inner}</div></td>`;
    }

    function modelPanel(r){
      const m = r.meta||{};
      const lines = [
        ['model', r.model],
        ['dataset', m.dataset],
        ['retriever', m.retriever],
        ['prompt', m.prompt_cfg || m.prompt],
        ['date', m.date],
        ['signature', m.signature_status || '—']
      ].filter(([,v])=> !!v).map(([k,v])=> `<span class="kv"><b>${k}:</b> ${escapeHTML(v)}</span>`).join(' · ');
      return `
        <div class="panel grid">
          <div><h4>Model meta</h4><p>${lines || '—'}</p></div>
        </div>
      `;
    }

    function provenancePanel(r){
      const p = r.provenance||{};
      const candidates = (p.topk || r.topk || []).map(c => 
        `<li>${escapeHTML(c.key||c.id||'source')} · chunk ${escapeHTML(String(c.chunk??'—'))} · score ${(c.score??'').toFixed?c.score.toFixed(3):escapeHTML(String(c.score??'—'))}</li>`
      ).join('') || '<li>—</li>';
      const cited = (p.citations || r.citations || []).map(c => `<li>${escapeHTML(c)}</li>`).join('') || '<li>—</li>';
      const merkle = p.merkle_root || r.merkle_root || (r.proof && r.proof.merkle_root);
      const proofLink = (r.proof && r.proof.url) ? `<a class="link" href="${r.proof.url}">download proof</a>` : (r.proof_path ? `<a class="link" href="${r.proof_path}">download proof</a>` : '');
      return `
        <div class="panel grid">
          <div>
            <h4>Retrieval candidates</h4>
            <ul class="list">${candidates}</ul>
          </div>
          <div>
            <h4>Citations used</h4>
            <ul class="list">${cited}</ul>
          </div>
          <div>
            <h4>Proof</h4>
            <p class="mono small">${merkle ? 'Merkle root: '+escapeHTML(merkle) : '—'} ${proofLink?(' · '+proofLink):''}</p>
          </div>
        </div>
      `;
    }

    function auditPanel(r){
      const a = r.audit||{};
      const lines = (a.findings || r.audit_findings || []).map(s=> `<li>${escapeHTML(s)}</li>`).join('') || '<li>—</li>';
      const status = r.audit_status || a.status || '—';
      return `
        <div class="panel">
          <h4>Audit</h4>
          <p>Status: <span class="badge ${status}">${escapeHTML(status)}</span></p>
          <ul class="list">${lines}</ul>
        </div>
      `;
    }

    function hydrateHeader(modelMap){
      // If a single model dominates, show that blurb; else generic
      const titleEl = document.getElementById('modelTitle');
      const blurbEl = document.getElementById('modelBlurb');
      const all = (data.runs||[]).map(r=> r.model).filter(Boolean);
      const top = all.length ? all.sort((a,b)=> all.filter(x=>x===b).length - all.filter(x=>x===a).length)[0] : null;
      if (top && modelMap[top]){
        titleEl.textContent = `${top} — TrustEval Pro`;
        blurbEl.textContent = modelMap[top].blurb || 'Provenance and audit folded into Trust.';
      }
    }
  })();
  </script>
</body>
</html>
